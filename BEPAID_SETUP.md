# Настройка bePaid для тестового режима

## Что такое bePaid?

bePaid - это белорусская платежная система, которая позволяет принимать онлайн-платежи:
- ✅ Поддерживает белорусские рубли (BYN)
- ✅ Банковские карты (Visa, MasterCard, БЕЛКАРТ)
- ✅ ЕРИП (Единое Расчётно-Информационное Пространство)
- ✅ Тестовый режим для разработки

## Шаг 1: Регистрация в bePaid

1. Перейдите на сайт [bePaid](https://bepaid.by)
2. Нажмите кнопку **"Подключиться"** в верхней части страницы (или перейдите по прямой ссылке: https://bepaid.by/podat-zajavku-bepaid)
3. Заполните форму регистрации:

   **Поля формы:**
   
   - **Имя** * (обязательное)
     - Введите ваше имя (например: `Иван`)
   
   - **Фамилия** * (обязательное)
     - Введите вашу фамилию (например: `Иванов`)
   
   - **Наименование юридического лица или ИП** (необязательное)
     - Если регистрируетесь как физическое лицо для тестирования, можно оставить пустым
     - Если есть ИП или ООО, укажите полное наименование (например: `ИП Иванов Иван Иванович` или `ООО "Название компании"`)
   
   - **УНП** * (обязательное)
     - УНП (Учетный номер плательщика) - это налоговый номер в Беларуси
     - Для физических лиц: можно указать ваш личный номер паспорта или любой тестовый номер (например: `123456789`)
     - Для ИП/ООО: укажите реальный УНП из свидетельства о регистрации
     - **Примечание:** Для тестового аккаунта можно использовать тестовые данные, но для продакшена потребуется реальный УНП
   
   - **E-mail** * (обязательное)
     - Введите ваш рабочий email адрес (можно использовать личный)
     - На этот email придет письмо с подтверждением и дальнейшими инструкциями
     - Пример: `your.email@example.com`
   
   - **Телефон** * (обязательное)
     - Введите номер телефона в формате: `+375 (XX) XXX-XX-XX` или `375XXXXXXXXX`
     - Пример: `+375 (29) 123-45-67` или `375291234567`
     - На этот номер могут позвонить для уточнения деталей
   
   - **Адрес сайта (если есть)** (необязательное)
     - Если у вас уже есть сайт, укажите его адрес (например: `https://mysite.com`)
     - Для тестирования можно указать `http://localhost:3000` или оставить пустым
   
   - **У меня есть промокод** (необязательное)
     - Отметьте чекбокс, если у вас есть промокод от bePaid
     - Обычно для тестового аккаунта промокод не требуется

4. Нажмите кнопку **"Отправить"**
5. После отправки формы:
   - На указанный email придет письмо с подтверждением получения заявки
   - С вами свяжется менеджер bePaid (обычно в течение 1-2 рабочих дней) для уточнения деталей
   - После обработки заявки вам предоставят доступ к личному кабинету

6. После получения доступа к личному кабинету создайте **тестовый магазин**:
   - Войдите в личный кабинет по ссылке: https://merchant.bepaid.by/
   - В личном кабинете нажмите "Добавить магазин" или "Магазины" → "Создать магазин"
   - Выберите "Тестовый магазин" (Test Shop)
   - Укажите адрес вашего сайта (для теста можно указать `http://localhost:3000`)
   - Заполните остальные обязательные поля (название магазина, описание и т.д.)

## Шаг 2: Получение ключей

После создания тестового магазина вам будут доступны:

1. **Shop ID** (ID магазина) - числовой идентификатор
2. **Secret Key** (Секретный ключ) - используется для аутентификации API запросов
3. **Webhook Secret** (Секрет для webhook) - используется для проверки подписи уведомлений

Где найти:
- В личном кабинете перейдите в раздел "Интеграция" → "Ключи API"
- Скопируйте Shop ID и Secret Key

## Шаг 3: Настройка переменных окружения

Создайте или обновите файл `.env.local` в корне проекта:

```env
# bePaid настройки
BEPAID_SHOP_ID=ваш_shop_id
BEPAID_SECRET_KEY=ваш_secret_key
BEPAID_WEBHOOK_SECRET=ваш_webhook_secret
BEPAID_TEST_MODE=true

# Базовый URL вашего сайта (для редиректов после оплаты)
NEXT_PUBLIC_BASE_URL=http://localhost:3000
```

**Важно:**
- `BEPAID_TEST_MODE=true` - включает тестовый режим (реальные деньги не списываются)
- Для продакшена установите `BEPAID_TEST_MODE=false`
- `NEXT_PUBLIC_BASE_URL` - должен быть доступен из интернета для webhook (в продакшене)

## Шаг 4: Настройка Webhook (для локальной разработки)

Для локальной разработки нужно настроить туннелирование, чтобы bePaid мог отправлять webhook на ваш локальный сервер.

### Вариант 1: Использовать ngrok (рекомендуется)

1. Установите [ngrok](https://ngrok.com/)
2. Запустите туннель:
   ```bash
   ngrok http 3000
   ```
3. Скопируйте HTTPS URL (например, `https://abc123.ngrok.io`)
4. В bePaid личном кабинете:
   - Перейдите в "Интеграция" → "HTTP-уведомления"
   - Укажите URL: `https://abc123.ngrok.io/api/bepaid/webhook`
   - Сохраните

### Вариант 2: Использовать локальный туннель

Альтернативные инструменты:
- [localtunnel](https://localtunnel.github.io/www/)
- [Cloudflare Tunnel](https://developers.cloudflare.com/cloudflare-one/connections/connect-apps/)

## Шаг 5: Тестирование

### Тестовые карты

bePaid предоставляет тестовые карты для проверки:

**Успешный платеж:**
- Номер: `4012888888881881`
- Дата: любая будущая (например, 12/25)
- CVC: любой 3-значный (например, 123)
- Имя: любое

**Отклоненный платеж:**
- Номер: `4000000000000002`

Полный список тестовых карт: [документация bePaid](https://docs.bepaid.by/ru/using_api/test_cards)

### Процесс тестирования

1. Запустите проект: `pnpm dev`
2. Добавьте товары в корзину
3. Перейдите к оформлению заказа
4. Заполните форму и нажмите "Оформить заказ"
5. Вы будете перенаправлены на страницу оплаты bePaid
6. Используйте тестовую карту `4012888888881881`
7. После успешной оплаты вы будете перенаправлены на `/checkout/success`

## Как это работает

### 1. Создание заказа (`app/serverActions.ts`)

```typescript
// При оформлении заказа:
// 1. Создаем заказ в базе данных
// 2. Вызываем createBepaidCheckout() для создания платежного токена
// 3. Получаем URL страницы оплаты bePaid
// 4. Редиректим пользователя на этот URL
```

### 2. Оплата на bePaid

- Пользователь вводит данные карты на странице bePaid
- bePaid обрабатывает платеж
- После оплаты bePaid редиректит пользователя обратно на ваш сайт

### 3. Webhook уведомление (`app/api/bepaid/webhook/route.ts`)

- bePaid отправляет POST запрос на `/api/bepaid/webhook`
- Мы проверяем подпись запроса (для безопасности)
- Обновляем статус заказа в базе данных:
  - `successful` → `SUCCEEDED`
  - `failed` → остается `PENDING`
  - `canceled` → `CANCELLED`

## Структура файлов

```
shared/lib/
  └── bepaid.ts              # Утилита для работы с bePaid API

app/
  ├── serverActions.ts       # Создание заказа и платежного токена
  └── api/bepaid/webhook/
      └── route.ts           # Обработка webhook уведомлений

app/(checkout)/checkout/success/
  └── page.tsx               # Страница успешной оплаты
```

## Переход в продакшен

1. Создайте реальный магазин в bePaid (не тестовый)
2. Получите продакшен ключи (Shop ID, Secret Key, Webhook Secret)
3. Обновите `.env.local`:
   ```env
   BEPAID_TEST_MODE=false
   BEPAID_SHOP_ID=продакшен_shop_id
   BEPAID_SECRET_KEY=продакшен_secret_key
   BEPAID_WEBHOOK_SECRET=продакшен_webhook_secret
   NEXT_PUBLIC_BASE_URL=https://ваш-домен.com
   ```
4. Настройте webhook URL в личном кабинете bePaid на продакшен домен

## Полезные ссылки

- [Документация bePaid](https://docs.bepaid.by)
- [API Reference](https://docs.bepaid.by/ru/using_api)
- [Тестовые карты](https://docs.bepaid.by/ru/using_api/test_cards)
- [Webhook документация](https://docs.bepaid.by/ru/using_api/webhooks)

## Поддержка

Если возникли вопросы:
- Техническая поддержка: help@bepaid.tech
- Отдел продаж: sales@bepaid.tech, +7 (495) 799-11-05
